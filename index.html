<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Checkerboard</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body {
    margin: 0;
    background: #0a1a2f;
    display: flex;
    justify-content: center;
    font-family: Arial, sans-serif;
    touch-action: manipulation;
}

#scale-root {
    display: flex;
    justify-content: center;
    width: 100vw;
}

#container {
    margin-top: 40px;
    text-align: center;
    transform-origin: top center;
}

button { cursor: pointer; }

/* Move controls slightly right */
#top-buttons,
#color-row {
    transform: translateX(20px);
}

/* ---------- TOP BUTTONS ---------- */
#top-buttons {
    margin-bottom: 12px;
}

#top-buttons button {
    font-family: "Comic Sans MS", cursive;
    font-size: 20px;
    padding: 8px 18px;
    margin: 0 6px;
    border-radius: 14px;
    border: 3px solid #222;
    background: linear-gradient(#ffffff, #eaeaea);
    box-shadow: 0 4px 0 #222;
}

#top-buttons button.selected {
    background: linear-gradient(#ffd700, #ffcc00);
}

/* ---------- COLOR ROW ---------- */
#color-row {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 14px;
    margin-bottom: 12px;
}

#color-row button {
    font-family: "Comic Sans MS", cursive;
    font-size: 16px;
    padding: 8px 16px;
    border-radius: 14px;
    border: 3px solid #222;
    background: linear-gradient(#ffffff, #eaeaea);
    box-shadow: 0 4px 0 #222;
}

.color-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: 3px solid #0a1a2f;
}

.color-btn.selected {
    border-color: white;
}

/* ---------- BOARD + LABELS ---------- */
#board-wrapper {
    display: grid;
    grid-template-columns: 45px auto;
    grid-template-rows: auto 45px;
    justify-content: center;
}

#rank-labels {
    display: grid;
    grid-template-rows: repeat(8, 75px);
    color: white;
    font-family: "Comic Sans MS", cursive;
    font-size: 22px;
    align-items: center;
    justify-items: center;
}

#file-labels {
    grid-column: 2;
    display: grid;
    grid-template-columns: repeat(8, 75px);
    color: white;
    font-family: "Comic Sans MS", cursive;
    font-size: 22px;
    align-items: center;
    justify-items: center;
}

/* ---------- BOARD ---------- */
#board {
    display: grid;
    grid-template-columns: repeat(8, 75px);
    grid-template-rows: repeat(8, 75px);
}

.square {
    width: 75px;
    height: 75px;
    border: 1px solid black;
    position: relative;
    user-select: none;
}

.white { background: #eeeed2; }
.black { background: #769656; }

.letter {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: "Comic Sans MS", "Segoe Script", "Bradley Hand", cursive;
    font-size: 26px;
    color: #d81f1f;
    pointer-events: none;
    z-index: 3;
}

.highlight {
    position: absolute;
    inset: 0;
    opacity: 0.45;
    z-index: 2;
}

.edit-input {
    position: absolute;
    inset: 0;
    z-index: 5;
    font-family: "Comic Sans MS", "Segoe Script", "Bradley Hand", cursive;
    font-size: 26px;
    text-align: center;
    border: none;
    outline: none;
    background: transparent;
    color: #d81f1f;
}

/* ---------- VISITORS ---------- */
#visitors-online {
    margin-top: 12px;
    color: white;
    font-family: "Comic Sans MS", cursive;
    font-size: 20px;
}
</style>
</head>

<body>

<div id="scale-root">
<div id="container">

<div id="top-buttons">
    <button id="btnC" onclick="selectPattern('C')">C</button>
    <button id="btnR" onclick="selectPattern('R')">R</button>
    <button id="btnT" onclick="selectPattern('T')">T</button>
</div>

<div id="color-row">
    <button onclick="undoEdits()">Undo</button>

    <div class="color-btn" style="background:#ff9999" onclick="setColor('#ff9999',this)"></div>
    <div class="color-btn" style="background:#cfa6ff" onclick="setColor('#cfa6ff',this)"></div>
    <div class="color-btn" style="background:#9fd6ff" onclick="setColor('#9fd6ff',this)"></div>
    <div class="color-btn selected" style="background:#ffd700" onclick="setColor('#ffd700',this)"></div>
    <div class="color-btn" style="background:#ffb347" onclick="setColor('#ffb347',this)"></div>
    <div class="color-btn" style="background:#9be29b" onclick="setColor('#9be29b',this)"></div>

    <button onclick="eraseHighlights()">Erase</button>
</div>

<div id="board-wrapper">
    <div id="rank-labels"></div>
    <div id="board"></div>
    <div id="file-labels"></div>
</div>

<div id="visitors-online">
    Visitors Online: <span id="visitor-count">0</span>
</div>

</div>
</div>

<script>
/* ðŸ”¥ FIREBASE CONFIG */
firebase.initializeApp({
    databaseURL: "https://realtime-a67ce-default-rtdb.firebaseio.com"
});

const database = firebase.database();

/* ðŸ”´ VISITORS */
const visitorsRef = database.ref("visitors");
const connectedRef = database.ref(".info/connected");
const visitorRef = visitorsRef.push();

connectedRef.on("value", snap => {
    if (snap.val()) {
        visitorRef.set(true);
        visitorRef.onDisconnect().remove();
    }
});

visitorsRef.on("value", snap => {
    document.getElementById("visitor-count").textContent = snap.numChildren();
});

/* ---------- BOARD LOGIC ---------- */
const board = document.getElementById("board");
const rankLabels = document.getElementById("rank-labels");
const fileLabels = document.getElementById("file-labels");

const patterns = {
    C: Array(8).fill("TCRTCRTC".split("")),
    R: Array(8).fill("RTCRTCRT".split("")),
    T: Array(8).fill("CRTCRTCR".split(""))
};

let currentPattern = "C";
let editedLetters = {};
let highlights = {};
let currentColor = "#ffd700";

/* DOUBLE TAP (DESKTOP + MOBILE) */
let lastTapTime = 0;
let lastSquare = null;
const DOUBLE_TAP_DELAY = 350;

for (let i = 8; i >= 1; i--) {
    rankLabels.appendChild(Object.assign(document.createElement("div"), {textContent:i}));
}
"abcdefgh".split("").forEach(l => {
    fileLabels.appendChild(Object.assign(document.createElement("div"), {textContent:l}));
});

function selectPattern(p) {
    currentPattern = p;
    document.querySelectorAll("#top-buttons button").forEach(b => b.classList.remove("selected"));
    document.getElementById("btn"+p).classList.add("selected");
    drawLetters();
}

function setColor(c, el) {
    currentColor = c;
    document.querySelectorAll(".color-btn").forEach(b => b.classList.remove("selected"));
    el.classList.add("selected");
}

function undoEdits() {
    editedLetters = {};
    drawLetters();
}

function eraseHighlights() {
    Object.values(highlights).forEach(h => h.remove());
    highlights = {};
}

function drawBoard() {
    board.innerHTML = "";
    for (let r=0;r<8;r++) for (let c=0;c<8;c++) {
        const sq = document.createElement("div");
        sq.className = `square ${(r+c)%2===0?'white':'black'}`;
        sq.dataset.key = `${r},${c}`;

        sq.addEventListener("pointerdown", e => handleTap(e, sq));

        const letter = document.createElement("div");
        letter.className = "letter";
        sq.appendChild(letter);

        board.appendChild(sq);
    }
    drawLetters();
}

function handleTap(e, sq) {
    e.preventDefault();
    const now = Date.now();
    const isDouble = sq === lastSquare && now - lastTapTime < DOUBLE_TAP_DELAY;

    lastTapTime = now;
    lastSquare = sq;

    if (isDouble) editSquare(sq);
    else toggleHighlight(sq);
}

function drawLetters() {
    document.querySelectorAll(".square").forEach(sq => {
        const key = sq.dataset.key;
        const [r,c] = key.split(",");
        sq.querySelector(".letter").textContent =
            editedLetters[key] ?? patterns[currentPattern][r][c];
    });
}

function toggleHighlight(sq) {
    const key = sq.dataset.key;
    if (highlights[key]) {
        highlights[key].remove();
        delete highlights[key];
    } else {
        const h = document.createElement("div");
        h.className = "highlight";
        h.style.background = currentColor;
        sq.appendChild(h);
        highlights[key] = h;
    }
}

function editSquare(sq) {
    if (sq.querySelector(".edit-input")) return;
    const key = sq.dataset.key;

    const input = document.createElement("input");
    input.className = "edit-input";
    input.value = sq.querySelector(".letter").textContent;
    sq.appendChild(input);

    requestAnimationFrame(() => input.focus());

    input.addEventListener("keydown", e => {
        if (e.key === "Enter") {
            editedLetters[key] = input.value;
            input.remove();
            drawLetters();
        }
    });

    input.addEventListener("blur", () => {
        editedLetters[key] = input.value;
        input.remove();
        drawLetters();
    });
}

/* ---------- AUTO SCALE + ORIENTATION ---------- */
function scaleToScreen() {
    const container = document.getElementById("container");
    const baseW = 800, baseH = 900;
    const scale = Math.min(window.innerWidth/baseW, window.innerHeight/baseH, 1);
    container.style.transform = `scale(${scale})`;
}

window.addEventListener("resize", scaleToScreen);
window.addEventListener("orientationchange", () => setTimeout(scaleToScreen, 200));

drawBoard();
selectPattern("C");
scaleToScreen();
</script>

</body>
</html>
